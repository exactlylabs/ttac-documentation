# Radar

Web application and software for monitoring of network and internet quality at physically remote sites.

Source code private but located at https://github.com/exactlylabs/radar

## Development

To get started with this project you'll need the following dependencies:

* Ruby 3.0.2
* Node 16.14.2
* Yarn 1.22.17
* PostgreSQL 13.6

To setup a new environment to run this project, you'll need a unix-based system (such as linux or MacOSX) to run the application, but you'll need a system with Linux and OpenSSH to run all functionality. Note, the current version of this project writes new files / SSH tunnel configurations to `/etc/ssh/sshd_config.d/` and will also reload the OpenSSH server. When running, the `rails server` process will need to run as a user with access to do these things.

To get started from the project's root directory:

1. `bundle install`
2. `yarn install`
3. `rails db:create db:migrate` -- note this assumes local socket based authorization to create and have full control over the database `radar_development`
4. `rails server` -- starts the server and displays the port it is running on

To get started, you can signup with a user at `http://localhost:3000` by default.

If you want to make the new user a super-user, you must do so manually by the following steps after signing up with the user on the website above:

1. `rails console` to start a Rails console, run the following at console
   1. `u = User.last` to select the recently created new user
   2. `u.superuser = true`
   3. `u.save!`

If you want to create a new pod configuration for testing run:

`curl -H "Accept: application/json" -XPOST http://localhost:3000/clients`

To simulate the client pinging, save the `unix_user` and `secret` from the body and use it as follows:

`curl -XPOST "http://localhost:3000/clients/<UNIX_USER>/status" -H 'Accept: application/json' -F "secret=<SECRET>"`

To simulate running a test:

`curl "http://localhost:3000/clients/<UNIX_USER>/measurements" -H 'Accept: application/json' -F "measurement[style]=OOKLA" -F "client_secret=<SECRET>" -F 'measurement[result]=@<FILE_WITH_TEST_RESULTS>'`

Test results for the simulated test run could be generated by running:

`./speedtest -f json --accept-license > ookla.json` OR `./ndt7-client -format json > ndt7.json`
Where `speedtest` is from Ookla's download page and `ndt7-client` is built and installed from https://github.com/m-lab/ndt7-client-go

## Operations

### Server

Currently Radar is deployed to a single debian 11 machine in GCP. Test results are stored in a GCP Storage Bucket. The radar web server is hosted behind a GCP Load Balancer with SSL required (non-SSL requests are redirected to SSL). The production environment is reachable at https://radar.exactlylabs.com. PostgreSQL is hosted by GCP's managed database product with automated backups.

To setup a new server, install `ruby`, `node`, `yarn` and at least the PostgreSQL client version listed at the start of the **Development** section and run the following:

1. `bundle install`
2. `yarn install`
3. `rails assets:precompile`

A startup script can then be created such as the following:

```
#!/usr/bin/env bash

set -e

export REMOTE_PORT_RANGE=33000-40000
export ENDPOINT_HOST=something.exactlylabs.com       # Replace this with your publicly available host name. This must not be behind the loadbalancer is it is used for Pods to SSH tunnel back to the server
export ENDPOINT_PORT=22
export RAILS_SERVE_STATIC_FILES=true
export DATABASE_URL=postgres://postgres:password@hostname/radar     # Replace this with your postgresl connection string
export SECRET_KEY_BASE=some_secure_random_string_here
export RAILS_ENV=production
export SMTP_PASSWORD=password       # Note, this is using the other configuration in the production.rb file

rails s -b 0.0.0.0
```

Currently this style script is run by a user with access to write files in `/etc/ssh/sshd_config.d/` and the ability to reload the OpenSSH server.

The server is the started by running the following from the radar directory:

`nohup ./start.sh &`

In the future, this style of start up should be replaced with a `systemd` configuration.

Note, given the current architecture, it is not possible to run the server in an HA configuration. This is due to the Pods needing a fixed location to SSH back to to create a tunnel for the purpose of live updating.

### Pod Configuration

This is an area of active development and rapid changes are still taking place to the specifications. Follow up with the Exactly Labs for current details on how a pod can be created and configured.

## Security and Pod Architecture

See the [Security Documentation](./security.md)
