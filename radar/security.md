# Radar Architecture and Security Overview

Radar is a collection of software that together creates the ability to remotely monitor the health and network conditions of links provided by Internet Service Providers. Today, this software is composed of a server and set of clients. The clients are physically installed at the sites with links to be monitored and the server receives the results from these remote clients.

The clients themselves are currently constructed in a prescriptive way in that the hardware and operating system is provided by the server operator. As a result, there are two categories of topics to cover regarding the clients: The software which communicates results back to the sever as well as the ability for the server operator to remotely manage the operating system to ensure system security and stability.

The server, like the client, has two categories of topics to consider regarding the architecture: the way in which data is collected, processed and presented from clients as well as how the server manages remote clients operating system stability.

Additionally, this document will mention the specific technologies and operating systems used for operations by TTAC (the National Telehealth Technology Assessment Resource Center) but will also describe when the technology was not a requirement and was more a configuration choice.
## Server Architecture

The server is made up of several components which together cover data collection, processing, presentation as well as remote client management. The server’s components include a database server (PostgreSQL), an SSH server (OpenSSH), a durable file storage technology (Google Cloud Storage), and the Radar software package written using the Ruby on Rails framework among other technologies. Ruby’s “Devise” software package is used to provide end-user authentication for management UIs.

The Radar software packages exposes a single HTTP-based API/Web endpoint for both receiving and servicing requests by the clients as well as to serve the web-based user experience. A PostgreSQL server as well as Google Cloud Storage are used by the Radar server package to store information related to the clients as well as broadband test results performed by the clients. The PostgreSQL and Cloud Storage endpoints are not exposed on the public internet and are just used behind firewalls as required to operate the Radar software.

For TTAC’s instance of the Radar server, the server and database run on a Debian 11 cloud-based server running within the Google Compute Platform (GCP). A GCP load balancer also provides TLS termination for the single exposed HTTP port. If a client attempts to access using non-TLS-secured standard endpoints, they will be redirected to the secure endpoint to ensure no sensitive data is transmitted over unencrypted channels. The Radar client package is configured to NOT follow redirection for API request to ensure that if, by accident, it is pointed at the unsecured endpoint it will not function.

Radar Client link test data will be accessible by the Radar Server’s web-based UI if an individual has access to the Radar Client’s Client ID and Client Secret. The web-UI is publicly accessible on the internet (currently TTAC runs this at https://radar.exactlylabs.com). An individual can create a web-based account and then associated that account with the Radar Client by providing the Client ID and Secret. Once associated, the web user will have access to basic information on the client such as the results of historical link tests. They will also have access to read and write basic metadata about the client such as its current physical address. A web-based user will never have access to remotely manage a client device unless they separately meet the additional requirements to remotely manage the client described in this document. Without the Radar Client and Secret, standard access control practices will prevent access by unauthorized individuals to a client’s test results. Note the Radar Server operator will have access to all Radar test results from all clients both with and without the web UI as they control the database and storage technologies where the test results are stored.

TTAC’s Debian server is configured to automatically apply security updates using the “UnattendedUpgrades” packages.

## Client Architecture

The Radar Client is composed of a set of Bash scripts which operate the broadband tests, upload the test results, and enable the remote configurations of a client. Given the nature of the client’s placement into secured environments, many precautions were taken to ensure that remote management is highly secured. The clients use both an SSH client (OpenSSH) as well as a SSH server (also OpenSSH) to facilitate remote management. CRON is used to ensure job scheduling of ISP link testing. Additionally, the ISP link tests are currently facilitated by Measurement Lab’s NDT7 test as well as Ookla “speedtest”.

Each client is issued a unique “Client ID” and “Client Secret” which together allow the client to identify and authorize itself with the Radar server before commands from the client will be accepted. With these, each client is authorized to transmit test results to the server for storage and to associate the results with the client’s given Client ID. Each client may only communicate to these specific secured server endpoints but are not granted access to other portions of the API. They do not have access to any APIs which allow for the updating or reading of information on any clients’ information including itself – just for the creation of new test results or remote management configurations. The management configurations contain a private key and server address to connect to. Note, this is described in more detail in a later section, but this configuration itself does not allow the server to remotely manage the client by itself – so in the case that this endpoint is compromised, it should still not be possible to remotely connect to the client or cause the client to take any unspecified action.

Given the way in which both running link tests and remote administration work, Client devices only require outbound network access on network ports 443 and 22 (though these ports can also be configured to be on different ports if needed). No inbound access is required. It is hoped that most normal secure environments would allow the needed access without any required changes to a firewall configuration unless being placed in a secured datacenter which restricts outbound access.

TTAC is specifically running its clients on the Raspberry PI 4B hardware platform with 32GB SD cards with casing and power supply selected to be physically durable in possibly unknown physical environments. The operating system is also Debian 11 with the UnattendedUpgrades package configured to automatically apply security updates. TTAC’s servers run the Radar server web endpoint at https://radar.exactlylabs.com and a SSH endpoint at radar-01.exactlylabs.com currently. Radar clients will also be accessing the web-based link test endpoints provided by the Measurement Lab and Ookla which will differ based on the physical location of the device.

## Client Lifecycle

The client’s would have the following lifecycle from both a physical and software perspective. This lifecycle is specific to TTAC’s current configuration; however, it may be easily adapted to other environments without significant alterations.
1. To create a client device, an individual may run a Bash script to create an SD card with a fully configured operating system and Radar client. This script also requires the individual provide an SSH public key to be installed. The corresponding private key will be later used to remotely. This script does the following:
    1. Copies the “golden” image to the SD card
    2. Copy the SSH public key to the client’s “authorized_keys” SSH file. This will allow remote management of this device to the holder of the corresponding private key
    3.	Calls a server endpoint which issues a new Client ID and Client Secret
    4.	Writes the Client ID and Secret to the SD card so the image is now specific to the device it will go into
    5.	Outputs the Client ID and Secret to the command line
2. Individual may then choose to print out a sticker with the ID and Secret to be attached to the client device so recipients can use this information to register the client in the Radar server’s UI. The SD card is also now inserted into the client device and the client device may be shipped to the site to be monitored
3. When Radar Client device is received by the site to be monitored, it is plugged into an ethernet port as well as a power outlet. This will also boot the device for the first time
4. Client device on boot up, will run a script which requests a remote management configuration from the server. It saves this configuration locally.
5. Client device uses its SSH client to open a connection to the Radar server’s SSH Server. This client must be run non-interactively (-N) or the server will not accept the client (done automatically within the golden image). The Client also includes a remote tunnel port (-R) which is configured to open a port on the server which is a gateway to the client’s running SSH Server. This means that individuals who have access to the server may also now attempt to authenticate to the Radar Client by accessing this port on the server. See the later section for a discussion of the security characteristics of this approach.
6. Client will, on scheduled intervals, run the NDT7 and Speedtest binaries. Each client’s output will then be sent to the server’s API endpoints using the client id and secret to identify itself and correlate the test results to the client id.
7. As needed, the individual who created the client device (who also controls the SSH private key who’s related public key was installed on the client) with the server operator (who controls access to the Radar server), may remotely connect to the client device to update the Radar scripts, change the tests being run, and make other operating system changes.
8. Eventually, the device may be decommissioned simply by unplugging it.

## Security Discussion

Given the nature of Client devices possibly operating behind firewalls at secured physical locations and the ability of a remote operator to run commands on the device, noteworthy effort was put into ensuring the security of the client devices.

The operation of the link testing and API reporting itself uses standard HTTPS technologies using industry standard levels of TLS and related algorithms. If needed, which specific algorithms used can be shared but they may change from time to time based on the current security best practices (at TTAC, this is handled automatically by Google Cloud Platform’s Load Balancers). The link testing itself does not cause any changes to take place on the client nor should they be able to cause the client to execute unspecified code on the client. Note that link testing is done using the third-party endpoints provided by the Measurement Lab and Ookla. The data sharing done by these entities is outside the scope of this document, but it should be assumed that the link test results are publicly available and are associated with the public IP address of the site running them.

All device operating systems operated by TTAC will have automated security patching. The Server also has automated source code scanning to ensuring any unsecured packages being used are flagged, patched and redeployed in a timely manner. This said, even if the Radar Server is compromised, given the architecture, an attacker would not have access to remotely execute commands on the Radar Client devices.

The remote management capability of the Client devices is where most of the effort to secure the platform was placed as it allows an authorized party to run arbitrary code on the client devices. It is worth noting, that if an operator chooses, they can fully disable this functionality, however, client devices communicating to the TTAC operated server will have this functionality enabled. This functionality’s primary goal is to reduce the cost associated with upgrading the link test suites without requiring a new device be physically shipped to a remote location.

## Client Management Surface Area

Client devices run a OpenSSH server on port 22. The client device is configured to only allow the ‘radar’ user to be used to connect to the device via SSH. Only SSH-key based authentication may be used to login with this user by default. The SSH public key installed on the client device was determined by the individual who created the client device image. It is intended that the related SSH private key will never be present on disk or in memory or the Radar server. It is also worth noting that this port may be configured to only listen on localhost. If configured this way, the client device will have no open network ports listening for inbound connections whatsoever. However, TTAC’s default configuration leaves this port open for debugging purposes today (with the above-mentioned login security).

When the client device is first turned on, it is given a SSH private key, SSH username, and a remote port number than may be used for tunneling by the Radar server. The server only stores the private key in memory before deleting it entirely. The client stores this private key to its .ssh/id_rsa file (default private key location) for the radar user. The client will then use this private key and username to authenticate back to the radar server’s SSH server. When the client opens its SSH client, it MAY NOT run any remote command. The Radar server’s SSH server has been configured to disallow all functions except for remote tunnel on one specific port per client for the user previously given to the Radar client. The client, when connecting back to the Radar server’s SSH server, will also open a remote tunnel on the specified port which connects to the Radar client’s SSH server running on localhost / port 22.

Given the above-mentioned setup, during normal operation, the Radar server will have each Radar client connected via SSH with a remote tunnel opened locally on the server only. It is expected (and is in the case of TTAC) that the range of ports given to Radar clients are also behind a firewall to ensure local-only access. To access these ports, the server operator must first connect to the server’s SSH server (with SSH agent forwarding enabled, e.g. -A). Then with the second private key which was used to generate the Radar client’s public key, the individual may then connect to the Radar client’s SSH server. Once this process is completed, the individual may now execute commands on the Radar Client. There is no scenario in which the Radar client’s SSH server will be exposed to the internet during this process by the Radar server. In summary, to access a client, a set of people must have SSH private keys for both the Radar Server and the Radar Client in order to execute remote commands on a Radar Client.

Note, in the case of TTAC it may be the case that the server operator and the individual creating the client image may be the same person or entity, however, with TTAC’s operation, it will never be the case that the private key installed on the Radar Client will be on the disk or in the memory of the Radar Server. The private key will only be used through SSH Agent Forwarding through the Radar Server.
